// ACTUAL BLANK FIELD FOR REAL USAGE
var field = [
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N']
			];
		

//Experimental field for testing purposes
/*
var field = [
				['I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'Z'],
				['I', 'I', 'Z', 'Z', 'Z', 'Z', 'I', 'I', 'I', 'Z'],
				['I', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N', 'Z'],
				['I', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N', 'N'],
				['I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'I'],
				['N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'Z', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'Z', 'Z', 'Z', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'Z'],
				['N', 'N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'Z'],
				['Z', 'Z', 'Z', 'Z', 'Z', 'Z', 'Z', 'Z', 'Z', 'Z'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'Z', 'Z'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'Z', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'Z', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'Z', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N']
			];

*/
			
var fieldRow = ['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'];			

const START_LINE = 26;
const KILL_LINE = 26;
const START_POS = 5;

var translateI;
var translateJ;

var removalList = [];
var activeTetromino;
var tracking = false;
var spawned = false;

const I_TRANSLATION = 0;
const J_TRANSLATION = 1;
const ROTATE_CLOCKWISE = 0;
const ROTATE_C_CLOCKWISE = 1;


function translationInIBound(shift) {
	var iBound = 
		((translateI + shift) - activeTetromino.p1.i >= 0 && (translateI + shift) - activeTetromino.p1.i < fieldRow.length) &
		((translateI + shift) - activeTetromino.p2.i >= 0 && (translateI + shift) - activeTetromino.p2.i < fieldRow.length) &
		((translateI + shift) - activeTetromino.p3.i >= 0 && (translateI + shift) - activeTetromino.p3.i < fieldRow.length) &
		((translateI + shift) - activeTetromino.p4.i >= 0 && (translateI + shift) - activeTetromino.p4.i < fieldRow.length) ;
	return iBound;
	
}

function translationInJBound(shift) {
	var jBound =
		((translateJ + shift) - activeTetromino.p1.j >= 0 ) &
		((translateJ + shift) - activeTetromino.p2.j >= 0 ) &
		((translateJ + shift) - activeTetromino.p3.j >= 0 ) &
		((translateJ + shift) - activeTetromino.p4.j >= 0 ) ;
	return jBound;
}

function pointIsSelf(i, j) {
	var isSelf =
		(activeTetromino.p1.i == i && activeTetromino.p1.j == j) |
		(activeTetromino.p2.i == i && activeTetromino.p2.j == j) |
		(activeTetromino.p3.i == i && activeTetromino.p3.j == j) |
		(activeTetromino.p4.i == i && activeTetromino.p4.j == j) ;
	return isSelf;
}


function translationIBlocked(shift) {
	var iBlocked =
		( field[translateJ - activeTetromino.p1.j][(translateI + shift) - activeTetromino.p1.i] != 'N' && !pointIsSelf(translateI, translateJ + shift) ) |
		( field[translateJ - activeTetromino.p2.j][(translateI + shift) - activeTetromino.p2.i] != 'N' && !pointIsSelf(translateI, translateJ + shift) ) |
		( field[translateJ - activeTetromino.p3.j][(translateI + shift) - activeTetromino.p3.i] != 'N' && !pointIsSelf(translateI, translateJ + shift) ) |
		( field[translateJ - activeTetromino.p4.j][(translateI + shift) - activeTetromino.p4.i] != 'N' && !pointIsSelf(translateI, translateJ + shift) ) ;
	return iBlocked;
}

function translationJBlocked(shift) {
	var jBlocked =
		( field[(translateJ + shift) - activeTetromino.p1.j][translateI - activeTetromino.p1.i] != 'N' && !pointIsSelf(translateI + shift, translateJ) ) |
		( field[(translateJ + shift) - activeTetromino.p2.j][translateI - activeTetromino.p2.i] != 'N' && !pointIsSelf(translateI + shift, translateJ) ) |
		( field[(translateJ + shift) - activeTetromino.p3.j][translateI - activeTetromino.p3.i] != 'N' && !pointIsSelf(translateI + shift, translateJ) ) |
		( field[(translateJ + shift) - activeTetromino.p4.j][translateI - activeTetromino.p4.i] != 'N' && !pointIsSelf(translateI + shift, translateJ) ) ;
	return jBlocked;
}

function tetrominoIllegalPosition() {
	var illegalPosition =
		( field[translateJ - activeTetromino.p1.j][translateI - activeTetromino.p1.i] != 'N' ) |
		( field[translateJ - activeTetromino.p2.j][translateI - activeTetromino.p2.i] != 'N' ) |
		( field[translateJ - activeTetromino.p3.j][translateI - activeTetromino.p3.i] != 'N' ) |
		( field[translateJ - activeTetromino.p4.j][translateI - activeTetromino.p4.i] != 'N' ) |
		
		!(translateJ - activeTetromino.p1.j >= 0 ) |
		!(translateJ - activeTetromino.p2.j >= 0 ) |
		!(translateJ - activeTetromino.p3.j >= 0 ) |
		!(translateJ - activeTetromino.p4.j >= 0 ) |
		
		!(translateI - activeTetromino.p1.i >= 0 && translateI - activeTetromino.p1.i < fieldRow.length) |
		!(translateI - activeTetromino.p2.i >= 0 && translateI - activeTetromino.p2.i < fieldRow.length) |
		!(translateI - activeTetromino.p3.i >= 0 && translateI - activeTetromino.p3.i < fieldRow.length) |
		!(translateI - activeTetromino.p4.i >= 0 && translateI - activeTetromino.p4.i < fieldRow.length) ;
	return illegalPosition;
}

function canRotate(rotation) {
	var rotatable;
	
	//floatTetromino();
	switch(rotation) {
		case ROTATE_CLOCKWISE:
			activeTetromino.advanceState();
			rotatable = !tetrominoIllegalPosition();
			activeTetromino.retreatState();
			break;
			
		case ROTATE_C_CLOCKWISE:
			activeTetromino.retreatState();
			rotatable = !tetrominoIllegalPosition();
			activeTetromino.advanceState();
			break;
	}
	//anchorTetromino();
	return rotatable;
}



function tetrominoImpacted() {
	var impacted =
		( field[(translateJ - 1) - activeTetromino.p1.j][translateI - activeTetromino.p1.i] != 'N' && !pointIsSelf(translateI - 1, translateJ) ) |
		( field[(translateJ - 1) - activeTetromino.p2.j][translateI - activeTetromino.p2.i] != 'N' && !pointIsSelf(translateI - 1, translateJ) ) |
		( field[(translateJ - 1) - activeTetromino.p3.j][translateI - activeTetromino.p3.i] != 'N' && !pointIsSelf(translateI - 1, translateJ) ) |
		( field[(translateJ - 1) - activeTetromino.p4.j][translateI - activeTetromino.p4.i] != 'N' && !pointIsSelf(translateI - 1, translateJ) ) ;
	return impacted;
}


function translateTetromino(direction, shift) {
	if(!tracking) {
		return;
	}
	
	floatTetromino();
	
	switch(direction) {
		case I_TRANSLATION:
			if(translationInIBound(shift) && !translationIBlocked(shift)) {
				translateI += shift;
			}
			break;
		case J_TRANSLATION:
			if(translationInJBound(shift) && !translationJBlocked(shift)) {
				translateJ += shift;
			}
			break;
	}
	
	anchorTetromino();
	
}

function rotateTetromino(direction) {
	if(!tracking) {
		return;
	}
	
	floatTetromino();
	
	switch(direction) {
		case ROTATE_CLOCKWISE:
			if(canRotate(ROTATE_CLOCKWISE)) {
				activeTetromino.advanceState();
			}
			break;
		case ROTATE_C_CLOCKWISE:
			if(canRotate(ROTATE_C_CLOCKWISE)) {
				activeTetromino.retreatState();
			}
			break;
	}
	
	anchorTetromino();
}

function floatTetromino() {
	field[translateJ - activeTetromino.p1.j][translateI - activeTetromino.p1.i] = 'N';
	field[translateJ - activeTetromino.p2.j][translateI - activeTetromino.p2.i] = 'N';
	field[translateJ - activeTetromino.p3.j][translateI - activeTetromino.p3.i] = 'N';
	field[translateJ - activeTetromino.p4.j][translateI - activeTetromino.p4.i] = 'N';
}

function anchorTetromino() {
	field[translateJ - activeTetromino.p1.j][translateI - activeTetromino.p1.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p2.j][translateI - activeTetromino.p2.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p3.j][translateI - activeTetromino.p3.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p4.j][translateI - activeTetromino.p4.i] = activeTetromino.drawChar;	
}

function activateTetromino(tetro) {
	activeTetromino = tetro;
	tracking = true;
	
	translateJ = START_LINE;
	translateI = START_POS;
}

function insertTetromino() {
	field[translateJ - activeTetromino.p1.j][translateI - activeTetromino.p1.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p2.j][translateI - activeTetromino.p2.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p3.j][translateI - activeTetromino.p3.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p4.j][translateI - activeTetromino.p4.i] = activeTetromino.drawChar;
	spawned = true;
}

function releaseTetromino() {
	activeTetronimo = null;
	tracking = false;
	spawned = false;
}

function spawnBlocked() {
	return (!spawned && tracking && tetrominoIllegalPosition());
}

function scanField() {
	for(i = 0; i < field.length; i++) {
		if(scanLine(i)) {
			removalList[removalList.length] = i;
		}
	}
}

function scanKillLine() {
	var any = false;
	
	for(var j = 0; j < field[KILL_LINE].length; j++) {
		any |= (field[KILL_LINE][j] != 'N') ? true : false ;
	}
	
	return any;
}

function scanLine(i) {
	var complete = true;
	for(j = 0; j < field[i].length; j++) {
		complete &= (field[i][j] != 'N') ? true : false ;
	}
	
	return complete;
}

function removeLines() {
	removalList.sort(function(a, b){return a - b});
	var ptr = removalList.length - 1;
	for(i = 0; i < removalList.length; i++) {
		removeLine(removalList[ptr--]);
	}
	removalList = [];
}

function removeLine(x) {
	for(j = x; j < field.length - 1; j++) {
		field[j] = field[j + 1].slice();
	}
}
	
	