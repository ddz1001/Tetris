// ACTUAL BLANK FIELD FOR REAL USAGE, 10 - 40 size
var field = [
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N']
			];
		

//Experimental field for testing purposes
/*
var field = [
				['I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'Z'],
				['I', 'I', 'Z', 'Z', 'Z', 'Z', 'I', 'I', 'I', 'Z'],
				['I', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N', 'Z'],
				['I', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N', 'N'],
				['I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'I'],
				['N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'Z', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'Z', 'Z', 'Z', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'Z'],
				['N', 'N', 'N', 'N', 'N', 'I', 'N', 'N', 'N', 'Z'],
				['Z', 'Z', 'Z', 'Z', 'Z', 'Z', 'Z', 'Z', 'Z', 'Z'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'Z', 'Z'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'Z', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'Z', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'Z', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'],
				['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N']
			];

*/
			
var fieldRow = ['N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N']; //Single row on the field	

const START_LINE = 26; //Line where tetrominos spawn
const KILL_LINE = 26; //Line which if filled indicates game over
const START_POS = 5; //Start position in middle of screen

var translateI; //Current I translation
var translateJ;	//Current J translation

var removalList = []; //List of lines to remove
var activeTetromino; //Current active tetromino
var tracking = false; //Check if the current piece is actively being tracked
var spawned = false; //Check if the piece is drawn to the field

const I_TRANSLATION = 0; //Flag for I translation
const J_TRANSLATION = 1; //Flag for J translation
const ROTATE_CLOCKWISE = 0; //Flag for clockwise rotation
const ROTATE_C_CLOCKWISE = 1; //Flag for counter clockwise rotation

/*Check if I translation is within the games bounds*/
function translationInIBound(shift) {
	var iBound = 
		((translateI + shift) - activeTetromino.p1.i >= 0 && (translateI + shift) - activeTetromino.p1.i < fieldRow.length) &
		((translateI + shift) - activeTetromino.p2.i >= 0 && (translateI + shift) - activeTetromino.p2.i < fieldRow.length) &
		((translateI + shift) - activeTetromino.p3.i >= 0 && (translateI + shift) - activeTetromino.p3.i < fieldRow.length) &
		((translateI + shift) - activeTetromino.p4.i >= 0 && (translateI + shift) - activeTetromino.p4.i < fieldRow.length) ;
	return iBound;
	
}
/*Check if J translation is within the games bounds*/
function translationInJBound(shift) {
	var jBound =
		((translateJ + shift) - activeTetromino.p1.j >= 0 ) &
		((translateJ + shift) - activeTetromino.p2.j >= 0 ) &
		((translateJ + shift) - activeTetromino.p3.j >= 0 ) &
		((translateJ + shift) - activeTetromino.p4.j >= 0 ) ;
	return jBound;
}

/*Check if the point being looked at belongs to the current active tetromino */
function pointIsSelf(i, j) {
	var isSelf =
		(activeTetromino.p1.i == i && activeTetromino.p1.j == j) |
		(activeTetromino.p2.i == i && activeTetromino.p2.j == j) |
		(activeTetromino.p3.i == i && activeTetromino.p3.j == j) |
		(activeTetromino.p4.i == i && activeTetromino.p4.j == j) ;
	return isSelf;
}

/*Check if I translation is blocked by another impacted tetromino */
function translationIBlocked(shift) {
	var iBlocked =
		( field[translateJ - activeTetromino.p1.j][(translateI + shift) - activeTetromino.p1.i] != 'N' && !pointIsSelf(translateI, translateJ + shift) ) |
		( field[translateJ - activeTetromino.p2.j][(translateI + shift) - activeTetromino.p2.i] != 'N' && !pointIsSelf(translateI, translateJ + shift) ) |
		( field[translateJ - activeTetromino.p3.j][(translateI + shift) - activeTetromino.p3.i] != 'N' && !pointIsSelf(translateI, translateJ + shift) ) |
		( field[translateJ - activeTetromino.p4.j][(translateI + shift) - activeTetromino.p4.i] != 'N' && !pointIsSelf(translateI, translateJ + shift) ) ;
	return iBlocked;
}
/*Check if J translation is blocked by another impacted tetromino */
function translationJBlocked(shift) {
	var jBlocked =
		( field[(translateJ + shift) - activeTetromino.p1.j][translateI - activeTetromino.p1.i] != 'N' && !pointIsSelf(translateI + shift, translateJ) ) |
		( field[(translateJ + shift) - activeTetromino.p2.j][translateI - activeTetromino.p2.i] != 'N' && !pointIsSelf(translateI + shift, translateJ) ) |
		( field[(translateJ + shift) - activeTetromino.p3.j][translateI - activeTetromino.p3.i] != 'N' && !pointIsSelf(translateI + shift, translateJ) ) |
		( field[(translateJ + shift) - activeTetromino.p4.j][translateI - activeTetromino.p4.i] != 'N' && !pointIsSelf(translateI + shift, translateJ) ) ;
	return jBlocked;
}

/*Check if the active tetromino is currently in an illegal position */
function tetrominoIllegalPosition() {
	var illegalPosition =
		( field[translateJ - activeTetromino.p1.j][translateI - activeTetromino.p1.i] != 'N' ) |
		( field[translateJ - activeTetromino.p2.j][translateI - activeTetromino.p2.i] != 'N' ) |
		( field[translateJ - activeTetromino.p3.j][translateI - activeTetromino.p3.i] != 'N' ) |
		( field[translateJ - activeTetromino.p4.j][translateI - activeTetromino.p4.i] != 'N' ) |
		
		!(translateJ - activeTetromino.p1.j >= 0 ) |
		!(translateJ - activeTetromino.p2.j >= 0 ) |
		!(translateJ - activeTetromino.p3.j >= 0 ) |
		!(translateJ - activeTetromino.p4.j >= 0 ) |
		
		!(translateI - activeTetromino.p1.i >= 0 && translateI - activeTetromino.p1.i < fieldRow.length) |
		!(translateI - activeTetromino.p2.i >= 0 && translateI - activeTetromino.p2.i < fieldRow.length) |
		!(translateI - activeTetromino.p3.i >= 0 && translateI - activeTetromino.p3.i < fieldRow.length) |
		!(translateI - activeTetromino.p4.i >= 0 && translateI - activeTetromino.p4.i < fieldRow.length) ;
	return illegalPosition;
}

/*Check if the active tetromino can rotate */
function canRotate(rotation) {
	var rotatable;
	
	switch(rotation) {
		case ROTATE_CLOCKWISE:
			activeTetromino.advanceState();
			rotatable = !tetrominoIllegalPosition();
			activeTetromino.retreatState();
			break;
			
		case ROTATE_C_CLOCKWISE:
			activeTetromino.retreatState();
			rotatable = !tetrominoIllegalPosition();
			activeTetromino.advanceState();
			break;
	}
	return rotatable;
}


/*Check if the current active tetromino has impacted either the bottom of the field or another piece */
function tetrominoImpacted() {
	floatTetromino();
	var impacted = !translationInJBound(-1) || translationJBlocked(-1);
	anchorTetromino();
	
	return impacted;
}

/*Translate the tetromino a given direction */
function translateTetromino(direction, shift) {
	if(!tracking) {
		return;
	}
	
	floatTetromino();
	
	switch(direction) {
		case I_TRANSLATION:
			if(translationInIBound(shift) && !translationIBlocked(shift)) {
				translateI += shift;
			}
			break;
		case J_TRANSLATION:
			if(translationInJBound(shift) && !translationJBlocked(shift)) {
				translateJ += shift;
			}
			break;
	}
	
	anchorTetromino();
	
}

/*Rotate the tetromino a given direction */
function rotateTetromino(direction) {
	if(!tracking) {
		return;
	}
	
	floatTetromino();
	
	switch(direction) {
		case ROTATE_CLOCKWISE:
			if(canRotate(ROTATE_CLOCKWISE)) {
				activeTetromino.advanceState();
			}
			break;
		case ROTATE_C_CLOCKWISE:
			if(canRotate(ROTATE_C_CLOCKWISE)) {
				activeTetromino.retreatState();
			}
			break;
	}
	
	anchorTetromino();
}

/*Erase the characters at the tetrominos current position for relocation */
function floatTetromino() {
	field[translateJ - activeTetromino.p1.j][translateI - activeTetromino.p1.i] = 'N';
	field[translateJ - activeTetromino.p2.j][translateI - activeTetromino.p2.i] = 'N';
	field[translateJ - activeTetromino.p3.j][translateI - activeTetromino.p3.i] = 'N';
	field[translateJ - activeTetromino.p4.j][translateI - activeTetromino.p4.i] = 'N';
}
/*Draw tetromino specified characters at its current position*/
function anchorTetromino() {
	field[translateJ - activeTetromino.p1.j][translateI - activeTetromino.p1.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p2.j][translateI - activeTetromino.p2.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p3.j][translateI - activeTetromino.p3.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p4.j][translateI - activeTetromino.p4.i] = activeTetromino.drawChar;	
}
/*Set the active tetromino */
function activateTetromino(tetro) {
	activeTetromino = tetro;
	tracking = true;
	
	translateJ = START_LINE;
	translateI = START_POS;
}
/*Draw the active tetromino to the field */
function insertTetromino() {
	field[translateJ - activeTetromino.p1.j][translateI - activeTetromino.p1.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p2.j][translateI - activeTetromino.p2.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p3.j][translateI - activeTetromino.p3.i] = activeTetromino.drawChar;
	field[translateJ - activeTetromino.p4.j][translateI - activeTetromino.p4.i] = activeTetromino.drawChar;
	spawned = true;
}
/*Release the active tetromino and allow another to be inserted */
function releaseTetromino() {
	activeTetronimo = null;
	tracking = false;
	spawned = false;
}
/*Check if the spawn is blocked */
function spawnBlocked() {
	return (!spawned && tracking && tetrominoIllegalPosition());
}

/*Scan the field for completed lines */
function scanField() {
	for(i = 0; i < field.length; i++) {
		if(scanLine(i)) {
			removalList[removalList.length] = i;
		}
	}
}

/*Scan the kill line */
function scanKillLine() {
	var any = false;
	
	for(var j = 0; j < field[KILL_LINE].length; j++) {
		any |= (field[KILL_LINE][j] != 'N') ? true : false ;
	}
	
	return any;
}

/*Scan a single line */
function scanLine(i) {
	var complete = true;
	for(j = 0; j < field[i].length; j++) {
		complete &= (field[i][j] != 'N') ? true : false ;
	}
	
	return complete;
}

/*Remove every line from the list */
function removeLines() {
	removalList.sort(function(a, b){return a - b}); //Sort removal to ensure top to bottom removal
	var ptr = removalList.length - 1;
	for(i = 0; i < removalList.length; i++) {
		removeLine(removalList[ptr--]);
	}
	removalList = [];
}
/*Remove a line and shift everything down */
function removeLine(x) {
	for(j = x; j < field.length - 1; j++) {
		field[j] = field[j + 1].slice();
	}
}
	
	